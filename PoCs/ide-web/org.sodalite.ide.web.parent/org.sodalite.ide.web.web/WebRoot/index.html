<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="Content-Language" content="en-us">
	<title>AADM Web Editor</title>
	<link rel="stylesheet" type="text/css" href="xtext/2.25.0/xtext-ace.css"/>
	<link rel="stylesheet" type="text/css" href="style.css"/>
	<script src="webjars/requirejs/2.3.6/require.min.js"></script>
	<script type="text/javascript">
		var baseUrl = window.location.pathname;
		var fileIndex = baseUrl.indexOf("index.html");
		if (fileIndex > 0)
			baseUrl = baseUrl.slice(0, fileIndex);
		require.config({
			baseUrl: baseUrl,
			paths: {
				"jquery": "webjars/jquery/3.5.1/jquery.min",
				"ace/ext/language_tools": "webjars/ace/1.3.3/src/ext-language_tools",
				"xtext/xtext-ace": "js/xtext-ace"
			}
		});
		require(["webjars/ace/1.3.3/src/ace"], function() {
			require(["xtext/xtext-ace"], function(xtext) {
				var editor = xtext.createEditor({
					baseUrl: baseUrl,
					syntaxDefinition: "xtext-resources/generated/mode-aadm2",
				});
				$("#save-button").click(function() {
					editor.xtextServices.saveResource();
				});
				$("#deploy-button").click(function() {
					//Add input elements to deployment form
					populate_deployment_form(editor);
				    $('.center').show();
				});
				$("#change-resource").change(function() {
					var resourceId = $("#change-resource option:selected").attr("value");
					editor.xtextServices.serviceBuilder.changeResource(resourceId);
				});
				$('#close').on('click', function () {
				    $('.center').hide();
				})
			});
		});
		
		function populate_deployment_form(editor) {
			// read AADM model from editor
			let model = editor.xtextServices.editorContext._serverState.text.replace(/\t/g, ' ').replace(/\n/g, ' ');
			// parse model to get inputs
			let myRegexp = new RegExp("inputs:(.*?)node_templates:"), match;
			match = myRegexp.exec(model);
			var inputs_block = null;
			var inputs = [];
			if (match != null)
				inputs_block = match[1];
			if (inputs_block != null){
				let regexp2 = /([\w-]+):/g;
				let iter = inputs_block.matchAll(regexp2);
				let result = Array.from(iter);
				for (key in result){
					if (result[key][1] != "type" && result[key][1] != "default")
						inputs.push(result[key][1]);
				}
			}	

			// Populate AADM inputs in form
			var div_inputs = document.querySelector('div[id="inputs"]');
			div_inputs.innerHTML = '';
			if (div_inputs != null && div_inputs.childElementCount == 0){
				var br = document.createElement("br");
				for (var i=0; i<inputs.length; i++){
					let input_label = document.createTextNode(inputs[i].concat(':'));
					var input_text = document.createElement("input");
					input_text.type = "text";
					input_text.name = inputs[i];
					input_text.value = "";
					div_inputs.appendChild(input_label);
					div_inputs.appendChild(input_text);
					div_inputs.appendChild(br.cloneNode());
				}
			}
		}
		
		function increase_worker() {
			var workers = document.querySelector('input[name="workers"]');
			workers.value = String(parseInt(workers.value) + 1)
		}
		
		function decrease_worker() {
			var workers = document.querySelector('input[name="workers"]');
			if (parseInt(workers.value) > 1)
				workers.value = String(parseInt(workers.value) - 1)
		}
	</script>
</head>
<body>
	<div class="header"><b>SODALITE IDE</b></div>
	<div class="header-editor">AADM Editor</div>
	<div class="container-buttons">
		<button id="save-button">Save AADM in KB</button>
		<button id="deploy-button">Deploy AADM</button>
		Select AADM: <select id="change-resource">
			<option value="snow.aadm">Snow AADM</option>
			<option value="test.aadm">Test AADM</option>
		</select>
	</div>
	<div class="container-editor">
		<div id="xtext-editor" 
			data-editor-xtext-lang="aadm"
			data-editor-resource-id="snow.aadm"
			data-editor-dirty-element="dirty-indicator"
			data-editor-enable-save-action="true"
			data-editor-enable-formatting-action="true"
			data-editor-show-error-dialogs="true"></div>
	</div>
	<div class="center hideform">
	    <button id="close" style="float: right;">X</button>
	    <b>AADM Deployment</b><br>
	    Provide inputs for the AADM
	    <hr>
	    <form action="">
	        Deployment name:
	        <input type="text" name="deployment_name" value="">
	        <br>
	        Version tag (optional):
	        <input type="text" name="version_tag" value="">
	        <br>
	        <span>Number orchestrator workers (optional):
	        <input type="button" name="workersdecrease" value="-" onclick="decrease_worker()">
	        <input type="button" name="workersincrease" value="+" onclick="increase_worker()">
	        <input type="text" name="workers" value="1">
	        </span>
	        <br>
	        Select a image build configuration (optional):
	       	<input type="file" id="imagebuildfile" name="ibfilename">
	        <br>
	        Complete AADM (optional):
	        <input type="checkbox" name="workers" value="">
	        <br>
	        Select an inputs file:
	        <input type="file" id="inputsfile" name="inputsfilename">
	        <br>
	        <hr>
	        <b>Inputs:</b>
	        <div id="inputs">
	        </div>
	        <br>
	        <input type="submit" value="Deploy">
	    </form>
	</div>
</body>
</html>

<script>
  const inputsfileField = document.querySelector('input[name="inputsfilename"]');
  inputsfileField.addEventListener('change', (event) => {
    const inputsfile = event.target.files[0];
    const reader = new FileReader();
    reader.addEventListener('load', (event) => {
      inputsFileContent = event.target.result;
      // Populate form with inputs values
      const inputs = inputsFileContent.split('\n');
      for (var i=0; i<inputs.length; i++){
    	  const input_entry = inputs[i];
    	  const input_pair = input_entry.split(':');
    	  const input_key = input_pair[0];
    	  const input_value = input_pair[1].trim();
    	  //Find input field by name, set its value
    	  const input_field = document.querySelector('input[name="'.concat(input_key).concat('"]'));
    	  if (input_field != null){
    		  input_field.value = input_value;
    	  }
      }
      
    });
    reader.readAsText(inputsfile);
    
  });
</script>
