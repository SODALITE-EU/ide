<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="Content-Language" content="en-us">
	<title>AADM Web Editor</title>
	<link rel="stylesheet" type="text/css" href="xtext/2.25.0/xtext-ace.css"/>
	<link rel="stylesheet" type="text/css" href="style.css"/>
	<script src="webjars/requirejs/2.3.6/require.min.js"></script>
	<script type="text/javascript">
		var baseUrl = window.location.pathname;
		var fileIndex = baseUrl.indexOf("index.html");
		if (fileIndex > 0)
			baseUrl = baseUrl.slice(0, fileIndex);
		require.config({
			baseUrl: baseUrl,
			paths: {
				"jquery": "webjars/jquery/3.5.1/jquery.min",
				"ace/ext/language_tools": "webjars/ace/1.3.3/src/ext-language_tools",
				"xtext/xtext-ace": "js/xtext-ace"
			}
		});
		require(["webjars/ace/1.3.3/src/ace"], function() {
			require(["xtext/xtext-ace"], function(xtext) {
				var editor = xtext.createEditor({
					baseUrl: baseUrl,
					syntaxDefinition: "xtext-resources/generated/mode-aadm2",
				});
				$("#save-button").click(function() {
					editor.xtextServices.saveResource();
				});
				$("#deploy-button").click(function() {
					//Add input elements to deployment form
					populate_deployment_form(editor);
				    $('.center').show();
				});
				$("#change-resource").change(function() {
					var resourceId = $("#change-resource option:selected").attr("value");
					editor.xtextServices.serviceBuilder.changeResource(resourceId);
				});
				$('#close').on('click', function () {
				    $('.center').hide();
				})
			});
		});
		
		function populate_deployment_form(editor) {
			//Reset form values
			const deployment_name = document.querySelector('input[name="deployment_name"]');
			deployment_name.value = '';
			const version_tag = document.querySelector('input[name="version_tag"]');
			version_tag.value = '';
			const workers = document.querySelector('input[name="workers"]');
			workers.value = '1';
			const complete = document.querySelector('input[name="complete"]');
			complete.checked = false;
			const ibfilename = document.querySelector('input[name="ibfilename"]');
			ibfilename.value = '';
			const inputsfilename = document.querySelector('input[name="inputsfilename"]');
			inputsfilename.value = '';
			
			// read AADM model from editor
			let model = editor.xtextServices.editorContext._serverState.text.replace(/\t/g, ' ').replace(/\n/g, ' ');
			// parse model to get inputs
			let myRegexp = new RegExp("inputs:(.*?)node_templates:"), match;
			match = myRegexp.exec(model);
			var inputs_block = null;
			var inputs = [];
			if (match != null)
				inputs_block = match[1];
			if (inputs_block != null){
				let regexp2 = /([\w-]+):/g;
				let iter = inputs_block.matchAll(regexp2);
				let result = Array.from(iter);
				_inputs = result[0]["input"].split(/(\s+)/);
				_inputs = _inputs.map(element => {
				  return element.trim();
				});
				_inputs = _inputs.filter(e => e);
				
				var inputs = {}
				for (i=0; i<_inputs.length; i+=3)
					inputs[_inputs[i].slice(0, -1)] = _inputs[i + 2];
			}	

			// Populate AADM inputs in form
			var div_inputs = document.querySelector('div[id="inputs"]');
			div_inputs.innerHTML = '';
			if (div_inputs != null && div_inputs.childElementCount == 0){
				var br = document.createElement("br");
				Object.entries(inputs).forEach(([input, type]) => {
					let input_label = document.createTextNode(input.concat(':'));
					var input_text = document.createElement("input");
					if (type != "map"){
						input_text.type = "text";
					} else {
						var input_text = document.createElement("textarea");
						input_text.form = "depl_form"
						input_text.rows = 5;
					}
					input_text.name = input;
					input_text.id = "form_text";
					input_text.value = "";
					div_inputs.appendChild(input_label);
					div_inputs.appendChild(input_text);
					div_inputs.appendChild(br.cloneNode());
				});
			}
			
			const form = document.getElementById( "depl_form" );
			// Capture submit event to send form content.
			form.addEventListener( "submit", function ( event ) {
				event.preventDefault();
				// Create deploy request query
				var query = "?";
				const deployment_name = document.querySelector('input[name="deployment_name"]').value
				query += "deployment_name=" + deployment_name;
				const version_tag = document.querySelector('input[name="version_tag"]').value
				if (version_tag != "")
					query += "&version_tag=" + version_tag;
				const workers = document.querySelector('input[name="workers"]').value
				if (workers != "")
					query += "&workers=" + workers;
				// IB Configuration: Read and transfer file content
				const reader = new FileReader();
    			reader.addEventListener('load', (event) => {
    				ibfilenameContent = event.target.result;
    			});
				if (ibfilenameContent != "")
					query += "&ibfilenameContent=" + ibfilenameContent;
				const completeField = document.querySelector('input[name="complete"]');
				const complete = completeField.checked;
				if (complete)
					query += "&complete=" + complete;
				// AADM inputs
				var inputs = "";
				var div_inputs = document.querySelector('div[id="inputs"]');
				for (var i=0; i<div_inputs.childNodes.length; i++){
					input_element = div_inputs.childNodes[i];
					if ((input_element instanceof HTMLInputElement && input_element.type == 'text') || input_element.type == 'textarea'){ //check input text
						value = processInputValue(input_element.value)
						if (value.includes("%0A"))
							inputs += input_element.name + ": %0A" + value + ";";
						else
							inputs += input_element.name + ": " + value + ";";
					}
				}
				if (inputs != "")
					query += "&inputs=" + inputs;
				editor.xtextServices.deploy(query);
				$('.center').hide();
			} );
		}
		
		function processInputValue(value){
			return value.replace(/\n/g, "%0A");
		}
		
		function increase_worker() {
			var workers = document.querySelector('input[name="workers"]');
			workers.value = String(parseInt(workers.value) + 1)
		}
		
		function decrease_worker() {
			var workers = document.querySelector('input[name="workers"]');
			if (parseInt(workers.value) > 1)
				workers.value = String(parseInt(workers.value) - 1)
		}
	</script>
</head>
<body>
	<div class="header"><b>SODALITE IDE</b></div>
	<div class="header-editor">AADM Editor</div>
	<div class="container-buttons">
		<button id="save-button" class="button">Save AADM in KB</button>
		<button id="deploy-button" class="button">Deploy AADM</button>
		<br>Select AADM: <select id="change-resource" class="button">
			<option value="snow.aadm" selected="true">Snow AADM</option>
			<option value="test.aadm">Test AADM</option>
			<option value="ml-application.aadm">ML App AADM</option>
		</select>
	</div>
	<div class="container-editor">
		<div id="xtext-editor" 
			data-editor-xtext-lang="aadm"
			data-editor-resource-id="snow.aadm"
			data-editor-dirty-element="dirty-indicator"
			data-editor-enable-save-action="true"
			data-editor-enable-formatting-action="true"
			data-editor-show-error-dialogs="true"></div>
	</div>
	<div class="center hideform">
	    <button id="close" style="float: right;">X</button>
	    <b>AADM Deployment</b><br>
	    Provide inputs for the AADM
	    <hr>
	    <form id="depl_form" action="">
	        Deployment name:
	        <input type="text" name="deployment_name" id= "form_text" value="">
	        <br>
	        Version tag (optional):
	        <input type="text" name="version_tag" id= "form_text" value="">
	        <br>
	        <span>Number orchestrator workers (optional):
	        <input type="button" name="workersdecrease" value="-" onclick="decrease_worker()">
	        <input type="button" name="workersincrease" value="+" onclick="increase_worker()">
	        <input type="text" name="workers" value="1">
	        </span>
	        <br>
	        Select a image build configuration (optional):
	       	<input type="file" id="imagebuildfile" name="ibfilename" value="">
	        <br>
	        Complete AADM (optional):
	        <input type="checkbox" name="complete" value="">
	        <br>
	        Select an inputs file:
	        <input type="file" id="inputsfile" name="inputsfilename" value="">
	        <br>
	        <hr>
	        <b>Inputs:</b>
	        <div id="inputs">
	        </div>
	        <br>
	        <input type="submit" value="Deploy">
	    </form>
	</div>
</body>
</html>

<script>
var ibfilenameContent = "";

const inputsfileField = document.querySelector('input[name="inputsfilename"]');
inputsfileField.addEventListener('change', (event) => {
    const inputsfile = event.target.files[0];
    const reader = new FileReader();
    reader.addEventListener('load', (event) => {
      inputsFileContent = event.target.result;
      // Populate form with inputs values
      const inputs = inputsFileContent.split('\n');
      inputs.forEach(processInput);
    });
    reader.readAsText(inputsfile);
});

function processInput(line, index, lines) {
	if (!line.trim().endsWith(":")) { // key:value entry
		processSingleInput(line, index, lines);
	} else { // map entry
		processMapInput(line, index, lines);
	}
}

function processMapInput(line, index, lines) {
	st = line.split(':');
	input_key = st[0];
	input_value = "";
	childLine = null;

	childLine = lines[++index];
	while (childLine != null && childLine.startsWith(" ")) {
		input_value += childLine + "\n";
		if (++index < lines.length)
			childLine = lines[index];
		else
			childLine = null;
	}
	
	const input_field = document.querySelector('textarea[name="'.concat(input_key).concat('"]'));
  	if (input_field != null){
  		if (input_value.endsWith("\n")){
			input_value = input_value.substring(0, input_value.length - 1);
  		}
		input_field.value = input_value;
  	}

	if (!childLine)
		processInput(childLine, index, lines);
}

function processSingleInput(line, index, lines) {
	if (!line)
		return;
	st = line.split(':');
	input_key = st[0];
	input_value = st[1]
	const input_field = document.querySelector('input[name="'.concat(input_key).concat('"]'));
  	if (input_field != null){
		input_field.value = input_value;
  	}

	if (++index < lines.length) {
		processInput(lines[index], index, lines);
	}
}

const ibfileField = document.querySelector('input[name="ibfilename"]');
ibfileField.addEventListener('change', (event) => {
    const ibfile = event.target.files[0];
    const reader = new FileReader();
    reader.addEventListener('load', (event) => {
    	ibfilenameContent = event.target.result;
    });
    reader.readAsText(ibfile);
});
</script>