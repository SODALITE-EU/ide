/*
 * generated by Xtext 2.23.0
 */
package org.sodalite.sdl.ansible.generator

import org.eclipse.emf.ecore.resource.Resource
import org.eclipse.xtext.generator.AbstractGenerator
import org.eclipse.xtext.generator.IFileSystemAccess2
import org.eclipse.xtext.generator.IGeneratorContext
import org.sodalite.sdl.ansible.ansibleDsl.EPlaybook
import org.sodalite.sdl.ansible.ansibleDsl.EPlay
import org.sodalite.sdl.ansible.ansibleDsl.EDictionary
import org.sodalite.sdl.ansible.ansibleDsl.EList
import java.util.ArrayList
import org.sodalite.sdl.ansible.ansibleDsl.EPlayExeSettings
import org.sodalite.sdl.ansible.ansibleDsl.EPlayErrorHandling
import org.sodalite.sdl.ansible.ansibleDsl.EFactsSettings
import org.sodalite.sdl.ansible.ansibleDsl.EBlockTask
import org.sodalite.sdl.ansible.ansibleDsl.ETaskHandler
import org.sodalite.sdl.ansible.ansibleDsl.EBlock
import org.sodalite.sdl.ansible.ansibleDsl.ETask
import org.sodalite.sdl.ansible.ansibleDsl.EHandler
import org.sodalite.sdl.ansible.ansibleDsl.EValuePassed
import org.sodalite.sdl.ansible.ansibleDsl.ENotifiedTopic
import org.sodalite.sdl.ansible.ansibleDsl.ENotifiedHandler
import org.sodalite.sdl.ansible.ansibleDsl.ELoopOverList
import org.sodalite.sdl.ansible.ansibleDsl.EUntil
import org.sodalite.sdl.ansible.ansibleDsl.ERoleInclusion
import org.sodalite.sdl.ansible.ansibleDsl.EJinjaExpressionEvaluationWithoutBrackets
import org.sodalite.sdl.ansible.ansibleDsl.EFilteredExpression
import org.sodalite.sdl.ansible.ansibleDsl.EOrExpression
import org.sodalite.sdl.ansible.ansibleDsl.EAndExpression
import org.sodalite.sdl.ansible.ansibleDsl.ETruthExpression
import org.sodalite.sdl.ansible.ansibleDsl.EOperation
import org.sodalite.sdl.ansible.ansibleDsl.EIsExpression
import org.sodalite.sdl.ansible.ansibleDsl.EParenthesisedExpression
import org.sodalite.sdl.ansible.ansibleDsl.EValueWithoutString
import org.sodalite.sdl.ansible.ansibleDsl.EValuePassedToJinjaExpression
import org.sodalite.sdl.ansible.ansibleDsl.EComposedValue
import org.sodalite.sdl.ansible.ansibleDsl.ESimpleValueWithoutString
import org.sodalite.sdl.ansible.ansibleDsl.EJinjaExpressionEvaluation
import org.sodalite.sdl.ansible.ansibleDsl.EVariableDeclarationVariableReference
import org.sodalite.sdl.ansible.ansibleDsl.ERegisterVariableReference
import org.sodalite.sdl.ansible.ansibleDsl.ESpecialVariable
import org.sodalite.sdl.ansible.ansibleDsl.EInputOperationVariableReference
import org.sodalite.sdl.ansible.ansibleDsl.EInputInterfaceVariableReference
import org.sodalite.sdl.ansible.ansibleDsl.EListPassed
import org.sodalite.sdl.ansible.ansibleDsl.EDictionaryPassed
import org.sodalite.sdl.ansible.ansibleDsl.ENumberPassed
import org.sodalite.sdl.ansible.ansibleDsl.EBooleanPassed
import org.sodalite.sdl.ansible.ansibleDsl.EIndexOrLoopVariableReference
import org.sodalite.sdl.ansible.ansibleDsl.ETailElement
import org.sodalite.sdl.ansible.ansibleDsl.EBase
import org.sodalite.sdl.ansible.ansibleDsl.EExecution
import org.sodalite.sdl.ansible.ansibleDsl.ESetFactVariableReference
import org.sodalite.sdl.ansible.ansibleDsl.EBlockAndRoleErrorHandling
import org.sodalite.sdl.ansible.ansibleDsl.EJinjaStatement
import org.sodalite.sdl.ansible.ansibleDsl.EIfStatement
import org.sodalite.sdl.ansible.ansibleDsl.EForStatement
import org.sodalite.sdl.ansible.ansibleDsl.EWithLookup
import org.sodalite.sdl.ansible.ansibleDsl.ESquareBracketElement
import org.sodalite.sdl.ansible.ansibleDsl.EDictionaryInLine
import org.sodalite.sdl.ansible.ansibleDsl.EDictionaryIndented
import org.sodalite.sdl.ansible.ansibleDsl.EListInLine
import org.sodalite.sdl.ansible.ansibleDsl.EListIndented
import org.sodalite.sdl.ansible.ansibleDsl.EBooleanAnsible
import org.sodalite.sdl.ansible.ansibleDsl.EMultiLineExpression
import org.sodalite.sdl.ansible.ansibleDsl.EStringPassed
import org.sodalite.sdl.ansible.ansibleDsl.EFunctionCallOrVariable
import org.sodalite.sdl.ansible.ansibleDsl.EValueJinja
import org.sodalite.sdl.ansible.ansibleDsl.EDictionaryJinja
import org.sodalite.sdl.ansible.ansibleDsl.EListJinja
import org.sodalite.sdl.ansible.ansibleDsl.EComposedValueJinja
import org.sodalite.sdl.ansible.ansibleDsl.ESimpleValueJinja
import org.sodalite.sdl.ansible.ansibleDsl.EDictionaryPairJinja
import org.sodalite.sdl.ansible.ansibleDsl.EFunctionInput
import org.sodalite.sdl.ansible.ansibleDsl.EElementOfListIndented
import org.sodalite.sdl.ansible.ansibleDsl.EDictionaryOfListIndented
import org.sodalite.sdl.ansible.ansibleDsl.EDictionaryPair
import org.sodalite.sdl.ansible.ansibleDsl.ECondition
import org.sodalite.sdl.ansible.ansibleDsl.EListOfConditions
import org.sodalite.sdl.ansible.ansibleDsl.ENumber
import org.sodalite.sdl.ansible.ansibleDsl.EExternalFileInclusion
import org.sodalite.sdl.ansible.ansibleDsl.EVariableReference
import org.sodalite.sdl.ansible.ansibleDsl.ESliceNotation
import org.sodalite.sdl.ansible.ansibleDsl.EJinjaAndString
import org.sodalite.sdl.ansible.ansibleDsl.EJinjaOrString
import org.sodalite.sdl.ansible.ansibleDsl.LocalEInputOperationVariableReference
import org.sodalite.sdl.ansible.ansibleDsl.KBEInputOperationVariableReference
import org.sodalite.sdl.ansible.ansibleDsl.LocalEInputInterfaceVariableReference
import org.sodalite.sdl.ansible.ansibleDsl.KBEInputInterfaceVariableReference
import org.sodalite.sdl.ansible.YAMLOutputConfigurationProvider
import java.util.Arrays
import org.sodalite.sdl.ansible.ansibleDsl.ECollectionListPassed
import org.sodalite.sdl.ansible.ansibleDsl.ECollectionList
import org.sodalite.sdl.ansible.ansibleDsl.ECollectionListInLine
import org.sodalite.sdl.ansible.ansibleDsl.ECollectionListIndented
import org.sodalite.sdl.ansible.ansibleDsl.ECollectionFQN
import org.sodalite.sdl.ansible.ansibleDsl.EModuleCall
import org.sodalite.sdl.ansible.ansibleDsl.EStringWithoutQuotesPassed
import org.sodalite.sdl.ansible.ansibleDsl.EJinjaAndStringWithoutQuotes
import org.sodalite.sdl.ansible.ansibleDsl.EJinjaOrStringWithoutQuotes
import org.sodalite.sdl.ansible.ansibleDsl.ERoleName
import org.sodalite.sdl.ansible.ansibleDsl.ENumberOrStringWithoutQuotesPassed

/**
 * Generates code from your model files on save.
 * 
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#code-generation
 */
class AnsibleDslGenerator extends AbstractGenerator {

	override void doGenerate(Resource resource, IFileSystemAccess2 fsa, IGeneratorContext context) {
		for (e : resource.allContents.toIterable.filter(EPlaybook)){
			var String scriptFilePath = ""
			for(segment : Arrays.copyOfRange(resource.URI.segments,2,resource.URI.segments.size-1)) {
				scriptFilePath = scriptFilePath+"/"+ segment  //build the path in which the resource resides
			}
			scriptFilePath = scriptFilePath.replaceAll("%20", " ")
			var String scriptFileName = resource.getURI().lastSegment.toString()
			var String outFileBase = scriptFileName.substring(0,scriptFileName.lastIndexOf(".")) //extract the name of the resource without the extension
			fsa.generateFile(scriptFilePath+"/"+outFileBase + '.yaml',YAMLOutputConfigurationProvider::YAML_OUTPUT, compilePlays(e))
		}
	}
	
	def compilePlays(EPlaybook playbook) '''
		«FOR play : playbook.plays»
			«compilePlay(play, '  ')»
			
		«ENDFOR»
	'''
	
	def compilePlay(EPlay play, String space) '''
		«IF play.name !== null»
			- name: «compileStringPassed(play.name, space, false)»
			«IF play.hosts !== null»
				«space»hosts: «compileStringPassed(play.hosts, space, false)»
			«ENDIF»
			«IF play.external_file_inclusion !== null»
				«compileExternalFileInclusion(play.external_file_inclusion, space, false)»
			«ENDIF»
		«ELSE»
			«IF play.hosts !== null»
				- hosts: «compileStringPassed(play.hosts, space, false)»
				«IF play.external_file_inclusion !== null»
					«compileExternalFileInclusion(play.external_file_inclusion, space, false)»
				«ENDIF»
			«ELSE»
				«IF play.external_file_inclusion !== null»
					«compileExternalFileInclusion(play.external_file_inclusion, space, true)»
				«ENDIF»
			«ENDIF»
		«ENDIF»
		«compileBaseAttributes(play, space)»
		«IF play.play_exe_settings !== null»
			«compilePlayExeSettings(play.play_exe_settings, space)»
		«ENDIF»
		«IF play.error_handling !== null»
			«compilePlayErrorHandling(play.error_handling, space)»
		«ENDIF»
		«IF play.facts_settings !== null»
			«compileFactsSettings(play.facts_settings, space)»
		«ENDIF»
		«IF play.vars_files !== null»
			«space»vars_files: «compileListPassed(play.vars_files, space)»
		«ENDIF»
		«IF play.vars_prompt !== null»
			«space»vars_prompt: «compileListPassed(play.vars_prompt, space)»
		«ENDIF»
		«IF play.force_handlers !== null»
			«space»force_handlers: «compileBooleanPassed(play.force_handlers, space)»
		«ENDIF»
		«IF play.roles_inclusions !== null»
			«space»roles:
			«FOR role: play.roles_inclusions.roles»
				«compileRoleInclusion(role, space.concat('  '))»
			«ENDFOR»
		«ENDIF»
		«IF play.pre_tasks_list.size !== 0»
			
			«space»pre_tasks:
			«FOR blockTask: play.pre_tasks_list»
				
				«compileBlockTask(blockTask, space.concat('  '))»
			«ENDFOR»
		«ENDIF»
		«IF play.tasks_list.size !== 0»
			«space»tasks:
			«FOR blockTask: play.tasks_list»
				«compileBlockTask(blockTask, space.concat('  '))»
			«ENDFOR»
		«ENDIF»
		«IF play.post_tasks_list.size !== 0»
			
			«space»post_tasks:
			«FOR blockTask: play.post_tasks_list»
				
				«compileBlockTask(blockTask, space.concat('  '))»
			«ENDFOR»
		«ENDIF»
		«IF play.handlers.size !== 0»
			
			«space»handlers:
			«FOR handler: play.handlers»
				
				«compileTaskHandler(handler, space.concat('  '))»
			«ENDFOR»
		«ENDIF»
	'''
	
	//isFirstElementOfPlay is true if both play.name and play.hosts are null, so if import_playbook/include needs the '- ' before it 
	def compileExternalFileInclusion(EExternalFileInclusion externalFileInclusion, String space, boolean isFirstElementOfPlay)'''
		«IF externalFileInclusion !== null»
			«IF !isFirstElementOfPlay»
				«IF externalFileInclusion.import_playbook !== null»
					«space»import_playbook: «externalFileInclusion.import_playbook»
				«ELSEIF externalFileInclusion.include !== null»
					«space»include: «externalFileInclusion.include»
				«ENDIF»
			«ELSEIF isFirstElementOfPlay»
				«IF externalFileInclusion.import_playbook !== null»
					- import_playbook: «externalFileInclusion.import_playbook»
				«ELSEIF externalFileInclusion.include !== null»
					- include: «externalFileInclusion.include»
				«ENDIF»
			«ENDIF»		
			«IF externalFileInclusion.when_expression !== null»
				«space»when: «compileCondition(externalFileInclusion.when_expression, space)»
			«ENDIF»
		«ENDIF»
	'''
	
	def compileRoleInclusion(ERoleInclusion roleInclusion, String space)'''
		«space»- role: «compileRoleName(roleInclusion.getName(), space, false)»
		«compileBaseAttributes(roleInclusion, space.concat('  '))»
		«compileExecutionAttributes(roleInclusion, space.concat('  '))»
		«IF roleInclusion.error_handling !== null»
			«compileBlockAndRoleErrorHandling(roleInclusion.error_handling, space.concat('  '))»
		«ENDIF»
	'''
	
	def compileBaseAttributes(EBase base, String space) '''
		«IF base.privilege_escalation !== null»
			«IF base.privilege_escalation.become !== null»
				«space»become: «compileBooleanPassed(base.privilege_escalation.become, space)»
			«ENDIF»
			«IF base.privilege_escalation.become_exe !== null»
				«space»become_exe: «compileStringPassed(base.privilege_escalation.become_exe, space, false)»
			«ENDIF»
			«IF base.privilege_escalation.become_flags !== null»
				«space»become_flags: «compileStringPassed(base.privilege_escalation.become_flags, space, false)»
			«ENDIF»
			«IF base.privilege_escalation.become_method !== null»
				«space»become_method: «compileStringPassed(base.privilege_escalation.become_method, space, false)»
			«ENDIF»
			«IF base.privilege_escalation.become_user !== null»
				«space»become_user: «compileStringPassed(base.privilege_escalation.become_user, space, false)»
			«ENDIF»
		«ENDIF»
		«IF base.validation_mode !== null»
			«IF base.validation_mode.check_mode !== null»
				«space»check_moode: «compileBooleanPassed(base.validation_mode.check_mode, space)»
			«ENDIF»
			«IF base.validation_mode.diff !== null»
				«space»diff: «compileBooleanPassed(base.validation_mode.diff, space)»
			«ENDIF»
		«ENDIF»
		«IF base.connection !== null»
			«IF base.connection.connection !== null»
				«space»connection: «compileStringPassed(base.connection.connection, space, false)»
			«ENDIF»
			«IF base.connection.port !== null»
				«space»port: «compileNumberPassed(base.connection.port, space)»
			«ENDIF»
			«IF base.connection.remote_user !== null»
				«space»remote_user: «compileStringPassed(base.connection.remote_user, space, false)»
			«ENDIF»
		«ENDIF»
		«IF base.no_log !== null»
			«space»no_log: «compileBooleanPassed(base.no_log, space)»
		«ENDIF»
		«IF base.debugger !== null»
			«space»debugger: «compileStringPassed(base.debugger, space, false)»
		«ENDIF»
		«IF base.module_defaults !== null»
			«space»module_defaults: «compileValuePassed(base.module_defaults, space, false)»
		«ENDIF»
		«IF base.environment !== null»
			«space»environment: «compileValuePassed(base.environment, space, false)»
		«ENDIF»
		«IF base.collections !== null»
			«space»collections: «compileCollectionListPassed(base.collections, space)»
		«ENDIF»
		«IF base.tags !== null»
			«space»tags: «compileListPassed(base.tags, space)»
		«ENDIF»
		«IF base.variable_declarations.size !== 0»
			«space»vars:
			«FOR variable_declaration: base.variable_declarations»
				«space.concat('  ')»«variable_declaration.name»: «compileValuePassed(variable_declaration.value_passed, space.concat('  '), false).toString()»
			«ENDFOR»
		«ENDIF»
	'''
	
	def compilePlayExeSettings(EPlayExeSettings playExeSettings, String space) '''
		«IF playExeSettings.strategy !== null»
			«space»strategy: «compileStringPassed(playExeSettings.strategy, space, false)»
		«ENDIF»
		«IF playExeSettings.serial_list !== null»
			«space»serial: «compileValuePassed(playExeSettings.serial_list, space, false)»
		«ENDIF»
		«IF playExeSettings.order !== null»
			«space»order: «compileStringPassed(playExeSettings.order, space, false)»
		«ENDIF»
		«IF playExeSettings.throttle !== null»
			«space»throttle: «compileNumberPassed(playExeSettings.throttle, space)»
		«ENDIF»
		«IF playExeSettings.run_once !== null»
			«space»run_once: «compileBooleanPassed(playExeSettings.run_once, space)»
		«ENDIF»
	'''
	
	def compilePlayErrorHandling(EPlayErrorHandling playErrorHandling, String space) '''
		«IF playErrorHandling.max_fail_percentage !== null»
			«space»max_fail_percentage: «compileNumberPassed(playErrorHandling.max_fail_percentage, space)»
		«ENDIF»
		«IF playErrorHandling.any_errors_fatal !== null»
			«space»any_errors_fatal: «compileBooleanPassed(playErrorHandling.any_errors_fatal, space)»
		«ENDIF»
		«IF playErrorHandling.ignore_errors !== null»
			«space»ignore_errors: «compileBooleanPassed(playErrorHandling.ignore_errors, space)»
		«ENDIF»
		«IF playErrorHandling.ignore_unreachable !== null»
			«space»ignore_unreachable: «compileBooleanPassed(playErrorHandling.ignore_unreachable, space)»
		«ENDIF»
	'''
	
	def compileFactsSettings(EFactsSettings factsSettings, String space) '''
		«IF factsSettings.gather_facts !== null»
			«space»gather_facts: «compileBooleanPassed(factsSettings.gather_facts, space)»
		«ENDIF»
		«IF factsSettings.gather_subset !== null»
			«space»gather_subset: «compileValuePassed(factsSettings.gather_subset, space, false)»
		«ENDIF»
		«IF factsSettings.gather_timeout !== null»
			«space»gather_timeout: «compileNumberPassed(factsSettings.gather_timeout, space)»
		«ENDIF»
		«IF factsSettings.fact_path !== null»
			«space»fact_path: «compileStringPassed(factsSettings.fact_path, space, false)»
		«ENDIF»
	'''
	
	def compileBlockTask(EBlockTask blockTask, String space) '''
		«IF blockTask instanceof EBlock»
			«compileBlock(blockTask, space)»
		«ENDIF»
		«IF blockTask instanceof ETask»
			«compileTaskHandler(blockTask, space)»
		«ENDIF»
	'''
	
	def compileBlock(EBlock block, String space) '''
		«IF block.name !== null»
			«space»- name: «compileStringPassed(block.name, space.concat('  '), false)»
			«space.concat('  ')»block:
		«ELSE»
			«space»- block:
		«ENDIF»
		«IF block.tasks.size !== 0»
			«FOR task: block.tasks»
				«compileTaskHandler(task, space.concat('  ').concat('  '))»
			«ENDFOR»
		«ENDIF»
		«IF block.rescue_tasks.size !== 0»
			«space.concat('  ')»rescue: 
			«FOR task: block.rescue_tasks»
				«compileTaskHandler(task, space.concat('  ').concat('  '))»
			«ENDFOR»
		«ENDIF»
		«IF block.always_tasks.size !== 0»
			«space.concat('  ')»always: 
			«FOR task: block.always_tasks»
				«compileTaskHandler(task, space.concat('  ').concat('  '))»
			«ENDFOR»
		«ENDIF»
		«compileBaseAttributes(block, space.concat('  '))»
		«compileExecutionAttributes(block, space.concat('  '))»
		«IF block.error_handling !== null»
			«compileBlockAndRoleErrorHandling(block.error_handling, space.concat('  '))»
		«ENDIF»
	'''
	
	def compileBlockAndRoleErrorHandling(EBlockAndRoleErrorHandling blockAndRoleErrorHandling, String space)'''
		«IF blockAndRoleErrorHandling !== null»
			«IF blockAndRoleErrorHandling.any_errors_fatal !== null»
				«space»any_errors_fatal: «compileBooleanPassed(blockAndRoleErrorHandling.any_errors_fatal, space)»
			«ENDIF»
			«IF blockAndRoleErrorHandling.ignore_errors !== null»
				«space»ignore_errors: «compileBooleanPassed(blockAndRoleErrorHandling.ignore_errors, space)»
			«ENDIF»
			«IF blockAndRoleErrorHandling.ignore_unreachable !== null»
				«space»ignore_unreachable: «compileBooleanPassed(blockAndRoleErrorHandling.ignore_unreachable, space)»
			«ENDIF»
		«ENDIF»	
	'''
	
	def compileExecutionAttributes(EExecution execution, String space) '''
		«IF execution.exe_settings !== null»
			«IF execution.exe_settings.throttle != 0»
				«space»throttle: «compileNumberPassed(execution.exe_settings.throttle, space)»
			«ENDIF»
			«IF execution.exe_settings.run_once !== null»
				«space»run_once: «compileBooleanPassed(execution.exe_settings.run_once, space)»
			«ENDIF»
		«ENDIF»
		«IF execution.delegation !== null»
			«IF execution.delegation.delegate_to !== null»
				«space»delegate_to: «compileStringPassed(execution.delegation.delegate_to, space, false)»
			«ENDIF»
			«IF execution.delegation.delegate_facts !== null»
				«space»delegate_facts: «compileBooleanPassed(execution.delegation.delegate_facts, space)»
			«ENDIF»
		«ENDIF»
		«IF execution.when_expression !== null»
			«space»when: «compileCondition(execution.when_expression, space)»
		«ENDIF»
	'''
	
	//the name of the handler is a simple string because otherwise the scoping doesn't work, so this function is needed
	//to distinguish between the 2 different cases and get the name of task/handler
	def taskHandlerName(ETaskHandler taskHandler, String space){
		if (taskHandler instanceof ETask){
			//this check is necessary in order to not pass null to compileStringPassed
			if (taskHandler.name !== null) return compileStringPassed(taskHandler.name, space, false)
			else return null
		} 
		else if (taskHandler instanceof EHandler){
			if (taskHandler.name !== null) return "\"".concat(taskHandler.name.compileString).concat("\"")
			else return null
		}
	}
	
	//if the task/handler has a name, indent it correctly. the name of the module used is the first thing to show
	def compileTaskHandler(ETaskHandler taskHandler, String space) '''
		«IF taskHandlerName(taskHandler, space) !== null»
			«space»- name: «taskHandlerName(taskHandler, space.concat('  '))»
			«IF taskHandler.module !== null»
				«space.concat('  ')»«compileModuleName(taskHandler.module,space)»:«IF taskHandler.module.direct_parameter !== null» «compileValuePassed(taskHandler.module.direct_parameter, space.concat('  '), false)»«ENDIF»
				«FOR parameter: taskHandler.module.parameters»
					«space.concat('  ').concat('  ')»«parameter.name»: «compileValuePassed(parameter.value, space.concat('  ').concat('  '), false)»
				«ENDFOR»
			«ENDIF»
		«ELSE»
			«IF taskHandler.module !== null»
				«space»- «compileModuleName(taskHandler.module,space)»:«IF taskHandler.module.direct_parameter !== null» «compileValuePassed(taskHandler.module.direct_parameter, space.concat('  '), false)»«ENDIF»
				«FOR parameter: taskHandler.module.parameters»
					«space.concat('  ').concat('  ')»«parameter.name»: «compileValuePassed(parameter.value, space.concat('  ').concat('  '), false)»
				«ENDFOR»
			«ENDIF»
		«ENDIF»
		«compileBaseAttributes(taskHandler, space.concat('  '))»
		«compileExecutionAttributes(taskHandler, space.concat('  '))»
		«compileTaskHandlerAttributes(taskHandler, space.concat('  '))»
		«IF taskHandler instanceof EHandler»
			«IF taskHandler.listen_to.size !== 0»
				«space.concat('  ')»listen: «compileNotifiedTopics(taskHandler)»
			«ENDIF»
		«ENDIF»
	'''
	
	//the assumption is that the module used was already generated by the compileTaskHandler function
	def compileTaskHandlerAttributes(ETaskHandler taskHandler, String space) '''
		«IF taskHandler.error_handling !== null»
			«IF taskHandler.error_handling.changed_when !== null»
				«space»change_when: «compileCondition(taskHandler.error_handling.changed_when, space)»
			«ENDIF»
			«IF taskHandler.error_handling.failed_when !== null»
				«space»failed_when: «compileCondition(taskHandler.error_handling.failed_when, space)»
			«ENDIF»
			«IF taskHandler.error_handling.any_errors_fatal !== null»
				«space»any_errors_fatal: «compileBooleanPassed(taskHandler.error_handling.any_errors_fatal, space)»
			«ENDIF»
			«IF taskHandler.error_handling.ignore_errors !== null»
				«space»ignore_errors: «compileBooleanPassed(taskHandler.error_handling.ignore_errors, space)»
			«ENDIF»
			«IF taskHandler.error_handling.ignore_unreachable !== null»
				«space»ignore_unreachable: «compileBooleanPassed(taskHandler.error_handling.ignore_unreachable, space)»
			«ENDIF»
		«ENDIF»
		«IF taskHandler.action !== null»
			«space»action: «compileStringPassed(taskHandler.action, space, false)»
		«ENDIF»
		«IF taskHandler.asynchronous_settings !== null»
			«IF taskHandler.asynchronous_settings.async !== null»
				«space»async: «compileNumberPassed(taskHandler.asynchronous_settings.async, space)»
			«ENDIF»
			«IF taskHandler.asynchronous_settings.poll !== null»
				«space»poll: «compileNumberPassed(taskHandler.asynchronous_settings.poll, space)»
			«ENDIF»
		«ENDIF»
		«IF taskHandler.args !== null»
			«space»args: «compileDictionaryPassed(taskHandler.args, space)»
		«ENDIF»
		«IF taskHandler.notifiables.size !== 0»
			«space»notify: «compileNotifiables(taskHandler)»
		«ENDIF»
		«IF taskHandler.loop !== null»
			«IF taskHandler.loop instanceof ELoopOverList»
				«space»loop: «compileLoopList((taskHandler.loop as ELoopOverList).loop_list, space)»
				«IF (taskHandler.loop as ELoopOverList).loop_control !== null»
					«IF (taskHandler.loop as ELoopOverList).loop_control.label !== null»
						«space»label: «compileValuePassed((taskHandler.loop as ELoopOverList).loop_control.label, space, false)»
					«ENDIF»
					«IF (taskHandler.loop as ELoopOverList).loop_control.pause !== null»
						«space»pause: «compileNumberPassed((taskHandler.loop as ELoopOverList).loop_control.pause, space)»
					«ENDIF»
					«IF (taskHandler.loop as ELoopOverList).loop_control.index_var !== null»
						«space»index_var: «(taskHandler.loop as ELoopOverList).loop_control.index_var.name»
					«ENDIF»
					«IF (taskHandler.loop as ELoopOverList).loop_control.loop_var !== null»
						«space»loop_var: «(taskHandler.loop as ELoopOverList).loop_control.loop_var.name»
					«ENDIF»
					«IF (taskHandler.loop as ELoopOverList).loop_control.extended !== null»
						«space»extended: «compileBooleanPassed((taskHandler.loop as ELoopOverList).loop_control.extended, space)»
					«ENDIF»
				«ENDIF»
			«ENDIF»
			«IF taskHandler.loop instanceof EUntil»
				«IF (taskHandler.loop as EUntil).until !== null»
					«space»until: «compileJinjaExpressionEvaluationWithoutBrackets((taskHandler.loop as EUntil).until, space, true)»
				«ENDIF»
				«IF (taskHandler.loop as EUntil).retries !== null»
					«space»retries: «compileNumberPassed((taskHandler.loop as EUntil).retries, space)»
				«ENDIF»
				«IF (taskHandler.loop as EUntil).delay !== null»
					«space»delay: «compileNumberPassed((taskHandler.loop as EUntil).delay, space)»
				«ENDIF»
			«ENDIF»
			«IF taskHandler.loop instanceof EWithLookup»
				«IF (taskHandler.loop as EWithLookup).lookup !== null && (taskHandler.loop as EWithLookup).with_list !== null»
					«space»with_«(taskHandler.loop as EWithLookup).lookup»: «compileValuePassed((taskHandler.loop as EWithLookup).with_list, space, false).toString()»
				«ENDIF»
			«ENDIF»
		«ENDIF»
		«IF taskHandler.register !== null»
			«space»register: «taskHandler.register.name»
		«ENDIF»
	'''
	
	def compileNotifiables(ETaskHandler taskHandler){
		var newList = new ArrayList()
		for (notifiable : taskHandler.notifiables){
			if (notifiable instanceof ENotifiedTopic){
				newList.add("\"".concat(notifiable.name.compileString).concat("\""))
			}
			else if (notifiable instanceof ENotifiedHandler){
				newList.add("\"".concat(notifiable.name.name.compileString).concat("\""))
			}
		}
		return newList
	}
	
	def compileNotifiedTopics(EHandler handler){
		var newList = new ArrayList()
		for (listenedTopic : handler.listen_to){
			newList.add("\"".concat(listenedTopic.name.compileString).concat("\""))
		}
		return newList
	}
	
	def compileDictionaryPassed(EDictionaryPassed dictionaryPassed, String space){
		if (dictionaryPassed instanceof EDictionary) return compileDictionary(dictionaryPassed, space)
		else if (dictionaryPassed instanceof EJinjaExpressionEvaluation) return "\"".concat(compileJinjaExpressionEvaluation(dictionaryPassed, space)).concat("\"")
		else if (dictionaryPassed instanceof EJinjaStatement) return "\"".concat(compileJinjaStatement(dictionaryPassed, space, false)).concat("\"")
	}
	
	def compileCollectionListPassed(ECollectionListPassed collectionlistPassed, String space){
		if (collectionlistPassed instanceof ECollectionList) return compileCollectionList(collectionlistPassed, space)
		else if (collectionlistPassed instanceof EJinjaExpressionEvaluation) return "\"".concat(compileJinjaExpressionEvaluation(collectionlistPassed, space)).concat("\"")
		else if (collectionlistPassed instanceof EJinjaStatement) return "\"".concat(compileJinjaStatement(collectionlistPassed, space, false)).concat("\"")
	}
	
	def compileListPassed(EListPassed listPassed, String space){
		if (listPassed instanceof EList) return compileList(listPassed, space)
		else if (listPassed instanceof EJinjaExpressionEvaluation) return "\"".concat(compileJinjaExpressionEvaluation(listPassed, space)).concat("\"")
		else if (listPassed instanceof EJinjaStatement) return "\"".concat(compileJinjaStatement(listPassed, space, false)).concat("\"")
	}
	
	def compileNumberPassed(ENumberPassed numberPassed, String space){
		if (numberPassed instanceof EJinjaExpressionEvaluation) return "\"".concat(compileJinjaExpressionEvaluation(numberPassed, space)).concat("\"")
		else if (numberPassed.number_passed !== null) return numberPassed.number_passed.compileNumber
		else if (numberPassed.number_passed_null !== null) return numberPassed.number_passed_null
		else if (numberPassed instanceof EJinjaStatement) return "\"".concat(compileJinjaStatement(numberPassed, space, false)).concat("\"")
	}
	
	def compileBooleanPassed(EBooleanPassed booleanPassed, String space){
		if (booleanPassed instanceof EJinjaExpressionEvaluation) return "\"".concat(compileJinjaExpressionEvaluation(booleanPassed, space)).concat("\"")
		else if (booleanPassed.boolean_passed !== null) return compileBooleanAnsible(booleanPassed.boolean_passed)
		else if (booleanPassed instanceof EJinjaStatement) return "\"".concat(compileJinjaStatement(booleanPassed, space, false)).concat("\"")
	}
	
	def compileTailElement(ETailElement tailElement, String space, boolean isCondition){
		var tailElementString = ""
		if (tailElement.function_call !== null) tailElementString = tailElementString.concat(compileFunctionCall(tailElement.function_call, space, isCondition))
		for (squareBracketElement : tailElement.square_bracket_elements){
			tailElementString = tailElementString.concat(squareBracketElement.compileSquareBracketElement)
		}
		return tailElementString
	}
	
	def compileSquareBracketElement(ESquareBracketElement squareBracketElement){
		var stringToReturn = ""
		if (squareBracketElement.expression !== null) stringToReturn = stringToReturn.concat("[").concat(compileJinjaExpressionEvaluationWithoutBrackets(squareBracketElement.expression, "", false).toString()).concat("]")
		else if (squareBracketElement.slice_notation !== null) stringToReturn = stringToReturn.concat("[").concat(compileSliceNotation(squareBracketElement.slice_notation)).concat("]")
		return stringToReturn
	}
	
	def compileSliceNotation(ESliceNotation sliceNotation){
		var stringToReturn = ""
		//if this if is entered, then there are 2 colons
		if (sliceNotation.first_colon !== null){
			if (sliceNotation.start !== null) stringToReturn = stringToReturn.concat(compileNumber(sliceNotation.start))
			stringToReturn = stringToReturn.concat(sliceNotation.first_colon)
			if (sliceNotation.step !== null) stringToReturn = stringToReturn.concat(compileNumber(sliceNotation.step))
			//it shouldn't be null, the check is done just to be safe
			if (sliceNotation.second_colon !== null) stringToReturn = stringToReturn.concat(sliceNotation.second_colon)
			if (sliceNotation.stop !== null) stringToReturn = stringToReturn.concat(compileNumber(sliceNotation.stop))
		}
		//if this else is entered, then there is 1 colon
		else {
			if (sliceNotation.start !== null) stringToReturn = stringToReturn.concat(compileNumber(sliceNotation.start))
			//it shouldn't be null, the check is done just to be safe
			if (sliceNotation.colon !== null) stringToReturn = stringToReturn.concat(sliceNotation.colon)
			if (sliceNotation.stop !== null) stringToReturn = stringToReturn.concat(compileNumber(sliceNotation.stop))
		}
		return stringToReturn
	}
	
	//isCondition is true if this function is called inside a condition, like for example a when condition
	//knowing that it's necessary to decide if strings should be generated with " quotation marks (isCondition == true) or ' quotation marks (isCondition == true)
	def compileJinjaExpressionEvaluationWithoutBrackets(EJinjaExpressionEvaluationWithoutBrackets jinja, String space, boolean isCondition){
		var stringToReturn = ""
		if (jinja.expression_to_evaluate !== null){
			stringToReturn = stringToReturn.concat(compileFilteredExpression(jinja.expression_to_evaluate, space, isCondition))
		}
		for (ifBlock : jinja.if_chain){
			stringToReturn = stringToReturn.concat(" if ").concat(compileFilteredExpression(ifBlock.if_condition, space, isCondition))
			if (ifBlock.else_expression !== null) stringToReturn = stringToReturn.concat(" else ").concat(compileFilteredExpression(ifBlock.else_expression, space, isCondition))
		}
		return stringToReturn
	}

	def compileFunctionCall(EFunctionCallOrVariable functionCall, String space, boolean isCondition){
		var stringToReturn = functionCall.name
		if (functionCall.parameters.size !== 0){
			stringToReturn = stringToReturn.concat("(")
			for (var index = 0; index < functionCall.parameters.size; index++){	
				//the first parameter passed shouldn't have a comma before it, the others yes
				if (index == 0){
					stringToReturn = stringToReturn.concat(compileFunctionInput(functionCall.parameters.get(index), space, isCondition))
				}
				else {
					stringToReturn = stringToReturn.concat(", ").concat(compileFunctionInput(functionCall.parameters.get(index), space, isCondition))
				}
			}
			stringToReturn = stringToReturn.concat(")")	
		}
		else if (functionCall.empty_brackets !== null){
			stringToReturn = stringToReturn.concat("()")
		}
		return stringToReturn
	}
	
	def compileFunctionInput(EFunctionInput functionInput, String space, boolean isCondition){
		var stringToReturn = ""
		if (functionInput.parameter_name !== null) stringToReturn = stringToReturn.concat(functionInput.parameter_name).concat("=")
		if (functionInput.value !== null) stringToReturn = stringToReturn.concat(compileJinjaExpressionEvaluationWithoutBrackets(functionInput.value, space, isCondition).toString())
		return stringToReturn
	}
	
	def compileFilteredExpression(EFilteredExpression filteredExpression, String space, boolean isCondition){
		var stringToReturn = compileOrExpression(filteredExpression.to_filter, space, isCondition).toString()
		if (filteredExpression.filter !== null){
			stringToReturn = stringToReturn.concat(" | ").concat(compileFilteredExpression(filteredExpression.filter, space, isCondition).toString())
		}
		return stringToReturn
	}
	
	def compileOrExpression(EOrExpression orExpression, String space, boolean isCondition){
		var stringToReturn = compileAndExpression(orExpression.left_or, space, isCondition).toString()
		if (orExpression.right_or !== null){
			stringToReturn = stringToReturn.concat(" or ").concat(compileOrExpression(orExpression.right_or, space, isCondition).toString())
		}
		return stringToReturn
	}
	
	def compileAndExpression(EAndExpression andExpression, String space, boolean isCondition){
		var stringToReturn = compileTruthExpression(andExpression.left_and, space, isCondition).toString()
		if (andExpression.right_and !== null){
			stringToReturn = stringToReturn.concat(" and ").concat(compileAndExpression(andExpression.right_and, space, isCondition).toString())
		}
		return stringToReturn
	}
	
	def compileTruthExpression(ETruthExpression truthExpression, String space, boolean isCondition){
		var stringToReturn = compileOperation(truthExpression.left_value, space, isCondition).toString()
		if (truthExpression.equality_sign !== null && truthExpression.right_value !== null){
			stringToReturn = stringToReturn.concat(" ").concat(truthExpression.equality_sign).concat(" ").concat(compileTruthExpression(truthExpression.right_value, space, isCondition).toString())
		}
		return stringToReturn
	}
	
	def compileOperation(EOperation operation, String space, boolean isCondition){
		var stringToReturn = compileIsExpression(operation.left_operand, space, isCondition).toString()
		if (operation.operator !== null && operation.right_operand !== null){
			stringToReturn = stringToReturn.concat(" ").concat(operation.operator).concat(" ").concat(compileOperation(operation.right_operand, space, isCondition).toString())
		}
		return stringToReturn
	}
	
	def compileIsExpression(EIsExpression isExpression, String space, boolean isCondition){
		var stringToReturn = ""
		if (isExpression.not !== null) stringToReturn = stringToReturn.concat("not ")
		stringToReturn = stringToReturn.concat(compileParenthesisedExpression(isExpression.parenthesised_expression, space, isCondition).toString())
		if (isExpression.status !== null){
			stringToReturn = stringToReturn.concat(" is ").concat(compileIsExpression(isExpression.status, space, isCondition).toString())	
		}
		else if (isExpression.container_expression !== null){
			if (isExpression.not_in !== null){
				stringToReturn = stringToReturn.concat(" not in ").concat(compileIsExpression(isExpression.container_expression, space, isCondition).toString())
			}
			else {
				stringToReturn = stringToReturn.concat(" in ").concat(compileIsExpression(isExpression.container_expression, space, isCondition).toString())
			}
		}
		return stringToReturn
	}
	
	def compileParenthesisedExpression(EParenthesisedExpression parenthesisedExpression, String space, boolean isCondition){
		var stringToReturn = ""
		if (parenthesisedExpression.basic_value !== null) stringToReturn = stringToReturn.concat(compileValuePassedToJinjaExpression(parenthesisedExpression.basic_value, space, isCondition))
		else if (parenthesisedExpression.parenthesised_term !== null) stringToReturn = stringToReturn.concat("(").concat(compileJinjaExpressionEvaluationWithoutBrackets(parenthesisedExpression.parenthesised_term, space, isCondition).toString()).concat(")")
		for (squareBracketElement : parenthesisedExpression.square_bracket_elements){
			stringToReturn = stringToReturn.concat(squareBracketElement.compileSquareBracketElement)
		}
		for (tailElement : parenthesisedExpression.tail){
			stringToReturn = stringToReturn.concat(".").concat(compileTailElement(tailElement, space, isCondition))
		}
		return stringToReturn
	}
	
	def compileCollectionList(ECollectionList list, String space){
		if (list instanceof ECollectionListInLine){
			var newList = new ArrayList()
			for (element: list.elements){
				newList.add(compileCollectionFQN(element, space, false))
			}
			return newList
		}
		else if (list instanceof ECollectionListIndented){
			var listString = ""
			for (element : list.elements){
				listString = listString.concat('\n').concat(space).concat("  - ").concat(compileCollectionFQN(element, space.concat("  "), false).toString())
			}
			return listString
		}
	}
	
	
	def compileModuleName(EModuleCall module, String space){
		var namespace = ""
		var collectionName=""
		var name = ""
		var moduleName = ""
		namespace = compileStringWithoutQuotesPassed(module.firstPart,space,false).replace("\"","")
		if (module.secondPart !== null){
			if(module.thirdPart !== null){
				collectionName = compileStringWithoutQuotesPassed(module.secondPart,space,false).replace("\"","")
				moduleName = compileStringWithoutQuotesPassed(module.thirdPart,space,false).replace("\"","")
				name = "\"".concat(namespace).concat(".").concat(collectionName).concat(".").concat(moduleName).concat("\"")
			}
			else{
				collectionName = compileStringWithoutQuotesPassed(module.secondPart,space,false).replace("\"","")
				name = "\"".concat(namespace).concat(".").concat(collectionName).concat("\"")
			}
			
		}
		else{
			name = moduleName.concat(namespace)
		}
		return name
	}
	
	def compileCollectionFQN(ECollectionFQN collection, String space, boolean isInMultiLine){
		var namespace = ""
		var collectionName=""
		var fqn = ""
		if (collection.collectionName !== null){
			namespace = compileStringWithoutQuotesPassed(collection.namespaceOrFqn,space,false).replace("\"","")
			//namespace = compileStringWithoutQuotesPassed(collection.namespaceOrFqn,space,false)
			//namespace.replace("\"",""); 
			collectionName = compileStringWithoutQuotesPassed(collection.collectionName,space,false).replace("\"","")
			//collectionName = compileStringWithoutQuotesPassed(collection.collectionName,space,false)
			//collectionName.replace("\"",""); 
			fqn = "\"".concat(namespace).concat(".").concat(collectionName).concat("\"")
			//fqn = fqn.concat(compileStringPassed(collection.namespaceOrFqn,space,false)).concat(".").concat(compileStringPassed(collection.collectionName,space,false))
		}
		else{
			fqn = fqn.concat(compileStringWithoutQuotesPassed(collection.namespaceOrFqn,space,false))
		}
		
	/* 	if (collection instanceof ECollectionModuledFQN){
			fqn = fqn.concat(compileStringPassed((collection as ECollectionModuledFQN).namespace,space,false)).concat(".").concat(compileStringPassed((collection as ECollectionModuledFQN).collectionName,space,false))
		}
		else if (collection instanceof ECollectionFullFQN){
			fqn = compileStringPassed((collection as ECollectionFullFQN).fqn,space,false)
		}*/
		return fqn
	}
	
	
	def compileRoleName(ERoleName role, String space, boolean isInMultiLine){
		var namespaceOrRoleName = ""
		var collectionNameOrRoleName=""
		var simpleRoleName = ""
		var definedRoleName =""
		
		if(role.thirdPart !== null){
			namespaceOrRoleName = compileNumberOrStringWithoutQuotesPassed(role.firstPart,space,false).replace("\"","")
			collectionNameOrRoleName = compileStringWithoutQuotesPassed(role.secondPart,space,false).replace("\"","")
			simpleRoleName = compileStringWithoutQuotesPassed(role.thirdPart,space,false).replace("\"","")
			definedRoleName = "\"".concat(namespaceOrRoleName).concat(".").concat(collectionNameOrRoleName).concat(".").concat(simpleRoleName).concat("\"")
		}
		else if(role.secondPart !==null && role.thirdPart === null){
			namespaceOrRoleName = compileNumberOrStringWithoutQuotesPassed(role.firstPart,space,false).replace("\"","")
			collectionNameOrRoleName = compileStringWithoutQuotesPassed(role.secondPart,space,false).replace("\"","")
			definedRoleName = "\"".concat(namespaceOrRoleName).concat(".").concat(collectionNameOrRoleName).concat("\"")
		}
		else{
			namespaceOrRoleName = compileNumberOrStringWithoutQuotesPassed(role.firstPart,space,false).replace("\"","")
			definedRoleName = "\"".concat(namespaceOrRoleName).concat("\"")
		}
		return definedRoleName
	}
	
	
	def compileList(EList list, String space){
		if (list instanceof EListInLine){
			var newList = new ArrayList()
			for (element : list.elements){
				newList.add(compileValuePassed(element, space, false))
			}
			return newList			
		}
		else if (list instanceof EListIndented){
			var listString = ""
			for (element : list.elements){
				listString = listString.concat('\n').concat(space).concat("  - ").concat(compileElementOfListIndented(element, space.concat("  "), false).toString())
			}
			return listString
		}

	}
	
	def compileElementOfListIndented(EElementOfListIndented element, String space, boolean isInMultiLine){
		if (element instanceof EValuePassed) return compileValuePassed(element, space, isInMultiLine)
		else if (element instanceof EDictionaryOfListIndented) return compileDictionaryOfListIndented(element, space)
	}
	
	def compileValuePassed(EValuePassed valuePassed, String space, boolean isInMultiLine){
		if (valuePassed instanceof EStringPassed){
			return compileStringPassed(valuePassed, space, isInMultiLine)
		}
		else if (valuePassed instanceof EStringWithoutQuotesPassed){
			return compileStringWithoutQuotesPassed(valuePassed, space, isInMultiLine)
		}
		else if (valuePassed instanceof EValueWithoutString){
			return compileValueWithoutString(valuePassed, space)
		}
	}

	def compileStringPassed(EStringPassed stringPassed, String space, boolean isInMultiLine){
		if (stringPassed instanceof EJinjaAndString){
			return compileJinjaAndString(stringPassed, space, isInMultiLine)
		}
		else if (stringPassed instanceof EMultiLineExpression){
			return compileMultiLineExpression(stringPassed, space)
		}
	}
	
	def compileStringWithoutQuotesPassed(EStringWithoutQuotesPassed stringWithoutQuotesPassed, String space, boolean isInMultiLine){
		if (stringWithoutQuotesPassed instanceof EJinjaAndStringWithoutQuotes){
			return compileJinjaAndStringWithoutQuotes(stringWithoutQuotesPassed, space, isInMultiLine)
		}
		else if (stringWithoutQuotesPassed instanceof EMultiLineExpression){
			return compileMultiLineExpression(stringWithoutQuotesPassed, space)
		}
	}
	
	def compileNumberOrStringWithoutQuotesPassed(ENumberOrStringWithoutQuotesPassed numberOrStringWithoutQuotesPassed, String space, boolean isInMultiLine){
		if (numberOrStringWithoutQuotesPassed instanceof EStringWithoutQuotesPassed){
			return compileStringWithoutQuotesPassed(numberOrStringWithoutQuotesPassed, space, isInMultiLine)
		}
		else if (numberOrStringWithoutQuotesPassed instanceof ENumber){
			return compileNumber(numberOrStringWithoutQuotesPassed)
		}
	}
	
	//if it's a line of a multiline, then the quotation marks must be absent
	def compileJinjaAndStringWithoutQuotes(EJinjaAndStringWithoutQuotes jinja, String space, boolean isInMultiLine){
		var stringToReturn = ""
		if (!isInMultiLine) stringToReturn = stringToReturn.concat("\"")
		for (jinjaOrWithoutQuotes : jinja.jinja_expression_and_stringWithout){
			stringToReturn = stringToReturn.concat(compileJinjaOrStringWithoutQuotes(jinjaOrWithoutQuotes, space, isInMultiLine).toString())
		}
		if (!isInMultiLine) stringToReturn = stringToReturn.concat("\"")
		return stringToReturn
	}
	
	def compileJinjaOrStringWithoutQuotes(EJinjaOrStringWithoutQuotes jinja, String space, boolean isInMultiLine){
		if (jinja.stringWithoutQuotes !== null){
			return compileStringInPossibleMultiLine(jinja.stringWithoutQuotes, isInMultiLine)
		}
		else if (jinja instanceof EJinjaExpressionEvaluation){
			return compileJinjaExpressionEvaluation(jinja, space)
		}
		else if (jinja instanceof EJinjaStatement){
			return compileJinjaStatement(jinja, space, isInMultiLine)
		}
	}

	//if it's a line of a multiline, then the quotation marks must be absent
	def compileJinjaAndString(EJinjaAndString jinja, String space, boolean isInMultiLine){
		var stringToReturn = ""
		if (!isInMultiLine) stringToReturn = stringToReturn.concat("\"")
		for (jinjaOr : jinja.jinja_expression_and_string){
			stringToReturn = stringToReturn.concat(compileJinjaOrString(jinjaOr, space, isInMultiLine).toString())
		}
		if (!isInMultiLine) stringToReturn = stringToReturn.concat("\"")
		return stringToReturn
	}
	
	def compileMultiLineExpression(EMultiLineExpression multiLineExpression, String space){
		var stringToReturn = ""
		if (multiLineExpression.new_line_command !== null) stringToReturn = stringToReturn.concat(multiLineExpression.new_line_command)
		for (jinjaAndString : multiLineExpression.expressions){
			stringToReturn = stringToReturn.concat("\n").concat(space.concat("  ")).concat(compileJinjaAndString(jinjaAndString, space, true).toString())
		}
		return stringToReturn
	}
	
	
	
	def compileJinjaOrString(EJinjaOrString jinja, String space, boolean isInMultiLine){
		if (jinja.string !== null){
			return compileStringInPossibleMultiLine(jinja.string, isInMultiLine)
		}
		else if (jinja instanceof EJinjaExpressionEvaluation){
			return compileJinjaExpressionEvaluation(jinja, space)
		}
		else if (jinja instanceof EJinjaStatement){
			return compileJinjaStatement(jinja, space, isInMultiLine)
		}
	}
	
	//if there is the " or a \ inside a string, then in the original string there was a \, lost during the parsing"
	def compileString(String string){
		var stringToReturn = ""
		for (var index = 0; index < string.length; index++){
			val character = string.charAt(index)
			//if the character is different from both " and \, then it can be simply concatenated to the string to return
			if (character !== '"'.charAt(0) && character !== '\\'.charAt(0)) stringToReturn = stringToReturn.concat(character.toString())
			//else, before the character it must be concatenated the escape sign, wich was lost during the parsing
			else stringToReturn = stringToReturn.concat("\\").concat(character.toString())
		}
		return stringToReturn
	}
	
	//if isInMultiLine is false, compileString can be used
	//if isInMultiLine is true, the string belongs to a multiline and requires specific conditions for the parsing
	def compileStringInPossibleMultiLine(String string, boolean isInMultiLine){
		if (!isInMultiLine) return compileString(string)
		else {
			//the string belongs to a multiline
			var stringToReturn = ""
			for (var index = 0; index < string.length; index++){
				val character = string.charAt(index)
				//first condition: the character is different from both " and \, then it can be simply concatenated to the string to return
				//second condition: the character is \, but we are at the end of a line of the multiline. In this case the character can also be concatenated to the string to return
				if ( (character !== '"'.charAt(0) && character !== '\\'.charAt(0) ) || ( character == '\\'.charAt(0) && index == string.length-1) ) stringToReturn = stringToReturn.concat(character.toString())
				//else, before the character it must be concatenated the escape sign, wich was lost during the parsing
				else stringToReturn = stringToReturn.concat("\\").concat(character.toString())
			}
			return stringToReturn
		}
	}
	
	def compileJinjaExpressionEvaluation(EJinjaExpressionEvaluation jinja, String space){
		return "{{ ".concat(compileJinjaExpressionEvaluationWithoutBrackets(jinja.jinja_expression, space, false).toString()).concat(" }}")
	}
	
	def compileJinjaStatement(EJinjaStatement jinjaStatement, String space, boolean isInMultiLine){
		if (jinjaStatement instanceof EIfStatement){
			var stringToReturn = "{%"
			if (jinjaStatement.if_block_sign !== null) stringToReturn = stringToReturn.concat(jinjaStatement.if_block_sign)
			stringToReturn = stringToReturn.concat(" if ").concat(compileFilteredExpression(jinjaStatement.if_condition, space, false)).concat(" %}")
			stringToReturn = stringToReturn.concat(compileValuePassed(jinjaStatement.if_body, space, isInMultiLine).toString())
			//the elif blocks, if present
			for (elif : jinjaStatement.elif_blocks){
				stringToReturn = stringToReturn.concat("{%")
				if (elif.elif_block_sign !== null) stringToReturn = stringToReturn.concat(elif.elif_block_sign)
				stringToReturn = stringToReturn.concat(" elif ").concat(compileFilteredExpression(elif.elif_condition, space, false)).concat(" %}")
				stringToReturn = stringToReturn.concat(compileValuePassed(elif.elif_body, space, isInMultiLine).toString())
			}
			//the else block, if present
			if (jinjaStatement.else_body !== null){
				stringToReturn = stringToReturn.concat("{%")
				if (jinjaStatement.else_block_sign !== null) stringToReturn = stringToReturn.concat(jinjaStatement.else_block_sign)
				stringToReturn = stringToReturn.concat(" else %}")
				stringToReturn = stringToReturn.concat(compileValuePassed(jinjaStatement.else_body, space, isInMultiLine).toString())
			}
			//the endif part
			stringToReturn = stringToReturn.concat("{%")
			if (jinjaStatement.endif_block_sign !== null) stringToReturn = stringToReturn.concat(jinjaStatement.endif_block_sign)
			stringToReturn = stringToReturn.concat(" endif %}")
			return stringToReturn
		}
		else if (jinjaStatement instanceof EForStatement){
			var stringToReturn = "{%"
			if (jinjaStatement.for_block_sign !== null) stringToReturn = stringToReturn.concat(jinjaStatement.for_block_sign)
			//the identifiers written after the "for"
			for (var index = 0; index < jinjaStatement.identifiers.size ; index++){
				//the first identifier shouldn't have a comma before it, the others yes
				if (index == 0){
					stringToReturn = stringToReturn.concat(" for ").concat(jinjaStatement.identifiers.get(index))
				}
				else {
					stringToReturn = stringToReturn.concat(", ").concat(jinjaStatement.identifiers.get(index))
				}
			}
			//the list of items to iterate after the "in"
			stringToReturn = stringToReturn.concat(" in ").concat(compileFilteredExpression(jinjaStatement.list, space, false))
			//the filter, if present
			if (jinjaStatement.condition !== null) stringToReturn = stringToReturn.concat(" if ").concat(compileFilteredExpression(jinjaStatement.condition, space, false))
			//the recursive keyword, if present
			if (jinjaStatement.recursive !== null) stringToReturn = stringToReturn.concat(" ").concat(jinjaStatement.recursive)
			stringToReturn = stringToReturn.concat(" %}")
			//body of the for
			stringToReturn = stringToReturn.concat(compileValuePassed(jinjaStatement.for_body, space, isInMultiLine).toString())
			//the else block, if present
			if (jinjaStatement.else_body !== null){
				stringToReturn = stringToReturn.concat("{%")
				if (jinjaStatement.else_block_sign !== null) stringToReturn = stringToReturn.concat(jinjaStatement.else_block_sign)
				stringToReturn = stringToReturn.concat(" else %}")
				stringToReturn = stringToReturn.concat(compileValuePassed(jinjaStatement.else_body, space, isInMultiLine).toString())
			}
			//the endfor part
			stringToReturn = stringToReturn.concat("{%")
			if (jinjaStatement.endfor_block_sign !== null) stringToReturn = stringToReturn.concat(jinjaStatement.endfor_block_sign)
			stringToReturn = stringToReturn.concat(" endfor %}")
			return stringToReturn
		}
	}
	
	def compileValuePassedToJinjaExpression(EValuePassedToJinjaExpression valuePassedToJinjaExpression, String space, boolean isCondition){
		if (valuePassedToJinjaExpression instanceof EValueJinja) return compileValueJinja(valuePassedToJinjaExpression, space, isCondition).toString()
		else if (valuePassedToJinjaExpression instanceof ESpecialVariable){
			var specialVariableString = valuePassedToJinjaExpression.name
			return specialVariableString
		}
		else if (valuePassedToJinjaExpression instanceof EVariableReference){
			return compileVariableReference(valuePassedToJinjaExpression)
		}
		else if (valuePassedToJinjaExpression instanceof EFunctionCallOrVariable){
			return compileFunctionCall(valuePassedToJinjaExpression, space, isCondition)
		}
	}
	
	def compileVariableReference(EVariableReference variableReference){
		if (variableReference instanceof EVariableDeclarationVariableReference){
			var declaredVariableString = ""
			declaredVariableString = declaredVariableString.concat(variableReference.variable_declaration_variable_reference.name)
			return declaredVariableString
		}
		else if (variableReference instanceof ERegisterVariableReference){
			var registerVariableString = ""
			registerVariableString = registerVariableString.concat(variableReference.register_variable_reference.name)
			return registerVariableString
		}
		else if (variableReference instanceof  EInputOperationVariableReference){
			var inputOperationVariableString = ""
			if(variableReference.reference instanceof LocalEInputOperationVariableReference){
				inputOperationVariableString = inputOperationVariableString.concat((variableReference.reference as LocalEInputOperationVariableReference).name.name)
			}
			else if(variableReference.reference instanceof  KBEInputOperationVariableReference){
				inputOperationVariableString = inputOperationVariableString.concat((variableReference.reference as KBEInputOperationVariableReference).name)
			}
			return inputOperationVariableString
		}
		
		else if (variableReference instanceof EInputInterfaceVariableReference){
			var inputInterfaceVariableString = ""
			if(variableReference.reference instanceof LocalEInputInterfaceVariableReference){
				inputInterfaceVariableString = inputInterfaceVariableString.concat((variableReference.reference as LocalEInputInterfaceVariableReference).name.name)	
			}
			else if(variableReference.reference instanceof KBEInputInterfaceVariableReference){
				inputInterfaceVariableString = inputInterfaceVariableString.concat((variableReference.reference as KBEInputInterfaceVariableReference).name)	
			}
			
			return inputInterfaceVariableString
		}
		
		else if (variableReference instanceof EIndexOrLoopVariableReference){
			var indexOrLoopVariableString = ""
			indexOrLoopVariableString = indexOrLoopVariableString.concat(variableReference.index_or_loop_variable_reference.name)
			return indexOrLoopVariableString
		}
		else if (variableReference instanceof ESetFactVariableReference){
			var setFactVariableReferenceString = ""
			setFactVariableReferenceString = setFactVariableReferenceString.concat(variableReference.name.name)
			return setFactVariableReferenceString
		}
	}
	
	def compileLoopList(EValuePassed loopList, String space){
		if (loopList instanceof EJinjaAndString || loopList instanceof EList) return compileValuePassed(loopList, space, false)
		else return "[".concat(compileValuePassed(loopList, space, false).toString()).concat("]")
	}
	
	
	def compileValueJinja(EValueJinja valueJinja, String space, boolean isCondition){
		if (valueJinja instanceof EComposedValueJinja) return compileComposedValueJinja(valueJinja, space, isCondition)
		else if (valueJinja instanceof ESimpleValueJinja) return compileSimpleValueJinja(valueJinja, isCondition)
	}
	
	def compileComposedValueJinja(EComposedValueJinja composedValueJinja, String space, boolean isCondition){
		if (composedValueJinja instanceof EDictionaryJinja){
			var dictionaryString = "{"
			for (var index = 0; index < composedValueJinja.dictionary_pairs.size; index++){
				if (index == 0){
					dictionaryString = dictionaryString.concat(compileDictionaryPairJinja(composedValueJinja.dictionary_pairs.get(index), space, isCondition))
				}
				else {
					dictionaryString = dictionaryString.concat(", ").concat(compileDictionaryPairJinja(composedValueJinja.dictionary_pairs.get(index), space, isCondition))
				}
			}
			dictionaryString = dictionaryString.concat("}")
			return dictionaryString
		}
		else if (composedValueJinja instanceof EListJinja){
			var listString = "["
			for (var index = 0; index < composedValueJinja.elements.size; index++){
				if (index == 0){
					listString = listString.concat(compileJinjaExpressionEvaluationWithoutBrackets(composedValueJinja.elements.get(index), space, isCondition).toString())
				}
				else {
					listString = listString.concat(", ").concat(compileJinjaExpressionEvaluationWithoutBrackets(composedValueJinja.elements.get(index), space, isCondition).toString())
				}
			}
			listString = listString.concat("]")
			return listString
		}
	}
	
	def compileDictionaryPairJinja(EDictionaryPairJinja dictionaryPairJinja, String space, boolean isCondition){
		return "\'".concat(dictionaryPairJinja.name).concat("\'").concat(": ").concat(compileJinjaExpressionEvaluationWithoutBrackets(dictionaryPairJinja.value, space, isCondition).toString())
	}
	
	def compileValueWithoutString(EValueWithoutString valueWithoutString, String space){
		if (valueWithoutString instanceof EComposedValue) return compileComposedValue(valueWithoutString, space)
		else if (valueWithoutString instanceof ESimpleValueWithoutString) return valueWithoutString.compileSimpleValueWithoutString
	}
	
	def compileComposedValue(EComposedValue composedValue, String space){
		if (composedValue instanceof EList) return compileList(composedValue, space)
		else if (composedValue instanceof EDictionary) return compileDictionary(composedValue, space)
	}
	
	def compileDictionary(EDictionary dictionary, String space){
		if (dictionary instanceof EDictionaryInLine){
			var dictionaryString = '{'
			for (dictionary_pair : dictionary.dictionary_pairs){
				dictionaryString = dictionaryString.concat(compileDictionaryPair(dictionary_pair, space.concat("  "))).concat(', ')
			}
			dictionaryString = dictionaryString.substring(0, dictionaryString.length() - 2)
			dictionaryString = dictionaryString.concat('}')
			return dictionaryString			
		}
		else if (dictionary instanceof EDictionaryIndented){
			var dictionaryString = ""
			for (dictionary_pair : dictionary.dictionary_pairs){
				dictionaryString = dictionaryString.concat('\n').concat(space).concat("  ").concat(compileDictionaryPair(dictionary_pair, space.concat("  ")))
			}
			return dictionaryString
		}
	}
	
	def compileDictionaryPair(EDictionaryPair dictionaryPair, String space){
		//return "\'".concat(dictionaryPair.name).concat("\'").concat(": ").concat(compileValuePassed(dictionaryPair.value, space, false).toString())
		return dictionaryPair.name.concat(": ").concat(compileValuePassed(dictionaryPair.value, space, false).toString())
	}
	
	def compileDictionaryOfListIndented(EDictionaryOfListIndented dictionary, String space){
		var dictionaryString= ""
		for (var index = 0; index < dictionary.dictionary_pairs.size; index++){
			if (index == 0) dictionaryString = dictionaryString.concat(compileDictionaryPair(dictionary.dictionary_pairs.get(index), space.concat("  ")))
			else {
				dictionaryString = dictionaryString.concat('\n').concat(space).concat("  ").concat(compileDictionaryPair(dictionary.dictionary_pairs.get(index), space.concat("  ")))
			}
		}
		return dictionaryString
	}
	
	//isCondition is true if this function is called inside a condition, like for example a when condition
	//knowing that it's necessary to decide if strings should be generated with " quotation marks (isCondition == true) or ' quotation marks (isCondition == true)
	def compileSimpleValueJinja(ESimpleValueJinja simpleValueJinja, boolean isCondition){
		if (simpleValueJinja.simple_value !== null) return simpleValueJinja.simple_value
		else if (simpleValueJinja.simple_value_number !== null) return compileNumber(simpleValueJinja.simple_value_number)
		else if (simpleValueJinja.simple_value_string !== null){
			if (isCondition) return "\"".concat(simpleValueJinja.simple_value_string.compileString).concat("\"")
			else return "\'".concat(simpleValueJinja.simple_value_string.compileString).concat("\'")
		}
	}
	
	def compileSimpleValueWithoutString(ESimpleValueWithoutString simpleValueWithoutString){
		if (simpleValueWithoutString.simple_value_boolean !== null) return compileBooleanAnsible(simpleValueWithoutString.simple_value_boolean)
		else if (simpleValueWithoutString.simple_value_number !== null) return compileNumber(simpleValueWithoutString.simple_value_number)
		else if (simpleValueWithoutString.simple_value !== null) return simpleValueWithoutString.simple_value
	}
	
	def compileBooleanAnsible(EBooleanAnsible booleanAnsible){
		if (booleanAnsible.boolean_ansible !== null) return booleanAnsible.boolean_ansible
	}
	
	def compileNumber(ENumber number){
		var stringToReturn = ""
		stringToReturn = stringToReturn.concat(number.number)
		return stringToReturn
	}
	
	def compileCondition(ECondition condition, String space){
		if (condition instanceof EJinjaExpressionEvaluationWithoutBrackets) return compileJinjaExpressionEvaluationWithoutBrackets(condition, space, true)
		else if (condition instanceof EListOfConditions){
			var listString = ""
			for (element : condition.conditions){
				listString = listString.concat('\n').concat(space).concat("  - ").concat(compileJinjaExpressionEvaluationWithoutBrackets(element, space.concat("  "), true))
			}
			return listString
		}
	}

}
